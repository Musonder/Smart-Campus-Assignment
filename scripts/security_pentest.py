"""
Security Pen-Test Harness

Runs a small suite of automated checks against the API Gateway:
- JWT replay attempt
- Role/privilege escalation attempt
- Simple injection payloads in query/body

Usage:
  python -m scripts.security_pentest
"""

import asyncio
import os
from typing import Any

import httpx

API_BASE = os.getenv("SEC_API_BASE", "http://localhost:8000")


async def attempt_privilege_escalation(client: httpx.AsyncClient, student_token: str) -> int:
  headers = {"Authorization": f"Bearer {student_token}"}
  # Student trying to hit an admin endpoint
  resp = await client.get(f"{API_BASE}/api/v1/admin/users", headers=headers)
  return resp.status_code


async def attempt_sql_injection(client: httpx.AsyncClient, token: str) -> int:
  headers = {"Authorization": f"Bearer {token}"}
  params = {"course_code": "CS-101'; DROP TABLE users; --"}
  resp = await client.get(f"{API_BASE}/api/v1/academic/sections", headers=headers, params=params)
  return resp.status_code


async def main() -> None:
  admin_token = os.getenv("SEC_ADMIN_ACCESS_TOKEN")
  student_token = os.getenv("SEC_STUDENT_ACCESS_TOKEN")

  if not admin_token or not student_token:
    print("Please set SEC_ADMIN_ACCESS_TOKEN and SEC_STUDENT_ACCESS_TOKEN env vars before running.")
    return

  async with httpx.AsyncClient(timeout=10.0) as client:
    # Privilege escalation: student hitting admin route should be 401/403
    status = await attempt_privilege_escalation(client, student_token)
    print(f"Privilege escalation attempt (studentâ†’admin) status: {status}")

    # Injection attempt: should not break system and should not be 500
    inj_status = await attempt_sql_injection(client, admin_token)
    print(f"SQL injection-like parameter status: {inj_status}")


if __name__ == "__main__":
  asyncio.run(main())


